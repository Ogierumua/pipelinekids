{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container my-4">

  <!-- Back -->
  <a href="{% url 'lesson_list' child.id module_key %}" class="text-decoration-none">
    ‚Üê Back to lessons
  </a>

  <h2 class="fw-bold mt-2">{{ lesson.title }}</h2>
  <div class="text-muted mb-3">
    {{ module_title }} ‚Ä¢ XP: {{ lesson.xp }}
  </div>

  {# -------------------------------
     VIDEO (embedded) + GATE CONTROL
     ------------------------------- #}
  {% if lesson.youtube_id %}
    <div class="my-4">

      <div class="ratio ratio-16x9 rounded overflow-hidden shadow">
        <iframe
          id="lessonVideo"
          src="https://www.youtube.com/embed/{{ lesson.youtube_id }}?rel=0&modestbranding=1"
          title="Lesson video"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen>
        </iframe>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
        <button id="unlockBtn" class="btn btn-primary">
          ‚úÖ I watched the video ‚Üí Unlock activity
        </button>

        <span class="small text-muted">
          Watch first, then unlock the mission task below.
        </span>
      </div>

    </div>
  {% endif %}

  {# -------------------------------
     ACTIVITY (hidden until unlocked)
     If no video, show activity normally
     ------------------------------- #}
  <div id="activityGateLocked" class="alert alert-warning {% if not lesson.youtube_id %}d-none{% endif %}">
    üîí Activity is locked. Watch the video, then click ‚ÄúUnlock activity‚Äù.
  </div>

  <div id="activitySection" class="{% if lesson.youtube_id %}d-none{% endif %}">
    {% if lesson.activity_type == "files3" %}
      {% include "activities/files_folders_3in1.html" %}
    {% elif lesson.activity_type == "word5" %}
      {% include "activities/word_5in1.html" %}
    {% elif lesson.activity_type == "excel8" %}
      {% include "activities/excel_8in1.html" %}
    {% elif lesson.activity_type == "ppt10" %}
      {% include "activities/ppt_10in1.html" %}
    {% elif lesson.activity_type == "cp12" %}
      {% include "activities/control_panel_12in1.html" %}
    {% elif lesson.activity_type == "safety12" %}
      {% include "activities/safety_12in1.html" %}
    {% elif lesson.activity_type == "jobs8" %}
      {% include "activities/jobs_8in1.html" %}
    {% elif lesson.activity_type == "logic5" %}
      {% include "activities/logic_5in1.html" %}
    {% elif lesson.activity_type == "net5" %}
      {% include "activities/networks_5in1.html" %}
    {% elif lesson.activity_type == "teams8" %}
      {% include "activities/teams8.html" %}
    {% elif lesson.activity_type == "career8" %}
      {% include "activities/career_engineers_8in1.html" %}
    {% elif lesson.activity_type == "netcloud8" %}
      {% include "activities/netcloud_8in1.html" %}
    {% elif lesson.activity_type == "cyberai8" %}
      {% include "activities/cyber_ai_8in1.html" %}
    {% elif lesson.activity_type == "project8" %}
      {% include "activities/project_ethics_paths_8in1.html" %}
    {% else %}
      <div class="alert alert-info">No activity for this lesson yet.</div>
    {% endif %}
  </div>

  <!-- COMPLETE BUTTON -->
  {% if not completed %}
    <button id="completeBtn" class="btn btn-success btn-lg mt-4">
      Complete mission +XP
    </button>
  {% else %}
    <div class="alert alert-success mt-4">
      Mission completed üéâ
    </div>
  {% endif %}

</div>

<script>
(function () {
  const hasVideo = {{ lesson.youtube_id|yesno:"true,false" }};
  if (!hasVideo) return;

  const lessonKey = "pk_video_unlocked_" + "{{ lesson.id }}";
  const unlockBtn = document.getElementById("unlockBtn");
  const lockedBox = document.getElementById("activityGateLocked");
  const activitySection = document.getElementById("activitySection");

  function unlock() {
    localStorage.setItem(lessonKey, "1");
    if (lockedBox) lockedBox.classList.add("d-none");
    if (activitySection) activitySection.classList.remove("d-none");
    if (unlockBtn) {
      unlockBtn.disabled = true;
      unlockBtn.textContent = "‚úÖ Activity unlocked";
      unlockBtn.classList.remove("btn-primary");
      unlockBtn.classList.add("btn-success");
    }
  }

  // Auto-unlock if already unlocked before
  if (localStorage.getItem(lessonKey) === "1") unlock();

  if (unlockBtn) unlockBtn.addEventListener("click", unlock);
})();
</script>

<script>
const btn = document.getElementById("completeBtn");
if (btn) {
  btn.addEventListener("click", async () => {
    const res = await fetch(
      "{% url 'lesson_complete' child.id module_key lesson.id %}",
      {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        }
      }
    );
    const data = await res.json();
    if (data.next_url) {
      window.location.href = data.next_url;
    } else {
      location.reload();
    }
  });
}
</script>

{% endblock %}
