<div class="card shadow-sm rounded-4 p-4 mt-4">
  <h4 class="fw-bold mb-1">üéÆ Playground: Systems + Memory + Storage</h4>
  <p class="text-muted mb-3">Complete all 5 activities to earn your badge ‚≠ê</p>

  <div class="progress mb-3" style="height: 12px;">
    <div id="sysBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
  </div>

  <div class="small text-muted mb-3">
    Completed: <span id="sysDone">0</span> / 5
  </div>

  <div id="sysActivities"></div>

  <div id="sysFinish" class="mt-4 d-none">
    <div class="alert alert-success rounded-4">
      ‚úÖ Amazing! You finished all activities! Badge unlocked: <strong id="sysBadge"></strong>
    </div>

    <button id="completeLessonBtn" class="btn btn-primary btn-lg w-100">
      ‚úÖ Complete Lesson + Earn XP
    </button>
  </div>
</div>

<script>
  const SYS_DATA = {{ lesson.activity_json|default:"{}"|safe }};
  const sysBox = document.getElementById("sysActivities");
  const sysDoneTxt = document.getElementById("sysDone");
  const sysBar = document.getElementById("sysBar");
  const sysFinish = document.getElementById("sysFinish");
  const sysBadge = document.getElementById("sysBadge");

  let sysDone = 0;
  const total = 5;
  const doneMap = {};

  function updateSysProgress() {
    sysDone = Object.keys(doneMap).length;
    sysDoneTxt.textContent = sysDone;
    sysBar.style.width = Math.round((sysDone / total) * 100) + "%";

    if (sysDone === total) {
      sysBadge.textContent = (SYS_DATA.badge || "System Star ‚≠ê");
      sysFinish.classList.remove("d-none");
    }
  }

  function markDone(key) {
    doneMap[key] = true;
    updateSysProgress();
  }

  function render() {
    const a = SYS_DATA.activities || [];

    sysBox.innerHTML = a.map((act, i) => {
      const key = "a" + i;
      if (act.type === "mcq") {
        return `
          <div class="border rounded-4 p-3 mb-3">
            <div class="fw-semibold mb-2">${act.title}</div>
            <div class="text-muted small mb-2">${act.prompt}</div>
            ${act.options.map((o, idx) => `
              <button class="btn btn-outline-secondary btn-sm me-2 mb-2"
                onclick="checkMCQ('${key}', ${idx})">${o.text}</button>
            `).join("")}
            <div id="${key}_msg" class="small mt-2"></div>
          </div>
        `;
      }

      if (act.type === "match") {
        return `
          <div class="border rounded-4 p-3 mb-3">
            <div class="fw-semibold mb-2">${act.title}</div>
            <div class="text-muted small mb-3">${act.prompt}</div>

            ${act.pairs.map((p, idx) => `
              <div class="d-flex align-items-center gap-2 mb-2">
                <span class="badge text-bg-light border">${p.left}</span>
                <select class="form-select form-select-sm w-auto" id="${key}_sel_${idx}">
                  <option value="">Choose‚Ä¶</option>
                  ${act.choices.map(c => `<option value="${c}">${c}</option>`).join("")}
                </select>
              </div>
            `).join("")}

            <button class="btn btn-primary btn-sm mt-2" onclick="checkMatch('${key}')">Check</button>
            <div id="${key}_msg" class="small mt-2"></div>
          </div>
        `;
      }

      if (act.type === "order") {
        return `
          <div class="border rounded-4 p-3 mb-3">
            <div class="fw-semibold mb-2">${act.title}</div>
            <div class="text-muted small mb-3">${act.prompt}</div>

            <div class="d-flex flex-wrap gap-2" id="${key}_pool">
              ${act.items.map((t, idx) => `
                <button class="btn btn-outline-secondary btn-sm" onclick="pickOrder('${key}', '${t.replaceAll("'", "\\'")}')">${t}</button>
              `).join("")}
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Your order:</div>
              <div class="p-2 bg-light rounded-3" id="${key}_out"></div>
            </div>

            <button class="btn btn-primary btn-sm mt-2" onclick="checkOrder('${key}')">Check order</button>
            <button class="btn btn-outline-secondary btn-sm mt-2 ms-2" onclick="resetOrder('${key}')">Reset</button>
            <div id="${key}_msg" class="small mt-2"></div>
          </div>
        `;
      }

      if (act.type === "truefalse") {
        return `
          <div class="border rounded-4 p-3 mb-3">
            <div class="fw-semibold mb-2">${act.title}</div>
            <div class="text-muted small mb-3">${act.prompt}</div>

            <button class="btn btn-outline-success btn-sm me-2" onclick="checkTF('${key}', true)">True</button>
            <button class="btn btn-outline-danger btn-sm" onclick="checkTF('${key}', false)">False</button>

            <div id="${key}_msg" class="small mt-2"></div>
          </div>
        `;
      }

      return "";
    }).join("");
  }

  // --- MCQ
  function checkMCQ(key, idx) {
    const actIndex = parseInt(key.replace("a",""));
    const act = SYS_DATA.activities[actIndex];
    const msg = document.getElementById(key + "_msg");
    const correct = act.options[idx].correct;

    msg.innerHTML = correct
      ? `<span class="text-success fw-semibold">‚úÖ Correct!</span> ${act.options[idx].feedback || ""}`
      : `<span class="text-danger fw-semibold">‚ùå Try again.</span>`;

    if (correct) markDone(key);
  }

  // --- True/False
  function checkTF(key, val) {
    const actIndex = parseInt(key.replace("a",""));
    const act = SYS_DATA.activities[actIndex];
    const msg = document.getElementById(key + "_msg");
    const correct = (val === act.correct);

    msg.innerHTML = correct
      ? `<span class="text-success fw-semibold">‚úÖ Correct!</span> ${act.feedback_correct || ""}`
      : `<span class="text-danger fw-semibold">‚ùå Not quite.</span> ${act.feedback_wrong || ""}`;

    if (correct) markDone(key);
  }

  // --- Match
  function checkMatch(key) {
    const actIndex = parseInt(key.replace("a",""));
    const act = SYS_DATA.activities[actIndex];
    const msg = document.getElementById(key + "_msg");

    let ok = true;
    act.pairs.forEach((p, idx) => {
      const sel = document.getElementById(`${key}_sel_${idx}`).value;
      if (sel !== p.right) ok = false;
    });

    msg.innerHTML = ok
      ? `<span class="text-success fw-semibold">‚úÖ Perfect matching!</span>`
      : `<span class="text-danger fw-semibold">‚ùå Some matches are wrong. Try again.</span>`;

    if (ok) markDone(key);
  }

  // --- Order
  const orderState = {};
  function pickOrder(key, item) {
    if (!orderState[key]) orderState[key] = [];
    orderState[key].push(item);
    document.getElementById(key + "_out").textContent = orderState[key].join(" ‚Üí ");
  }
  function resetOrder(key) {
    orderState[key] = [];
    document.getElementById(key + "_out").textContent = "";
    document.getElementById(key + "_msg").innerHTML = "";
  }
  function checkOrder(key) {
    const actIndex = parseInt(key.replace("a",""));
    const act = SYS_DATA.activities[actIndex];
    const msg = document.getElementById(key + "_msg");

    const user = (orderState[key] || []);
    const ok = JSON.stringify(user) === JSON.stringify(act.correct_order);

    msg.innerHTML = ok
      ? `<span class="text-success fw-semibold">‚úÖ Correct order!</span>`
      : `<span class="text-danger fw-semibold">‚ùå Not quite. Reset and try again.</span>`;

    if (ok) markDone(key);
  }

  // Complete lesson button (uses your existing endpoint)
  document.getElementById("completeLessonBtn")?.addEventListener("click", async () => {
    const btn = document.getElementById("completeLessonBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";

    const res = await fetch("{% url 'lesson_complete' child.id lesson.id %}", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });

    const data = await res.json();
    if (data.ok) {
      btn.textContent = `‚úÖ Completed (+${data.xp_awarded} XP)`;
      if (data.next_url) window.location.href = data.next_url;
    } else {
      btn.disabled = false;
      btn.textContent = "‚úÖ Complete Lesson + Earn XP";
      alert("Something went wrong, try again.");
    }
  });

  render();
  updateSysProgress();
</script>
