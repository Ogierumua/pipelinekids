{% load static %}

{# âœ… Pass JSON safely into JS #}
{{ lesson.activity_json|json_script:"activity-data" }}

<div class="container my-4">

  <!-- TITLE + INSTRUCTIONS -->
  <div class="text-center mb-4">
    <h2 class="fw-bold">{{ lesson.activity_json.title|default:"ğŸ® Mission" }}</h2>
    <p class="fs-5 mb-0">
      {{ lesson.activity_json.subtitle|default:"Drag the blocks into the box in the right order" }}
    </p>
  </div>

  <div class="row g-4">

    <!-- LEFT: INSTRUCTIONS -->
    <div class="col-md-4">
      <div class="p-3 bg-light rounded-4 shadow-sm h-100">
        <h4 class="fw-bold text-center mb-3">ğŸ§© Instructions</h4>

        {# âœ… blocks will be generated by JS #}
        <div id="instructions"></div>

        <p class="small text-muted text-center mt-3">
          Drag the blocks into the box in the right order
        </p>
      </div>
    </div>

    <!-- RIGHT: PLAYGROUND -->
    <div class="col-md-8">
      <div class="p-4 bg-white rounded-4 shadow-sm h-100">

        <h4 class="fw-bold text-center mb-3">ğŸ–¥ï¸ Playground</h4>

        <!-- DROP ZONE -->
        <div id="dropZone" class="drop-zone mb-4">
          <p class="drop-hint mb-0">Drop instruction blocks here ğŸ‘‡</p>
        </div>

        <!-- COMPUTER A -->
        <div class="computer-box mb-4">
          <div class="computer-title">ğŸ–¥ï¸ Computer A</div>

          <div class="parts-row mb-2">
            <span id="keyboardEl">âŒ¨ï¸ Keyboard</span>
            <span id="mouseEl" class="ms-3">ğŸ–±ï¸ Mouse</span>
          </div>

          <div id="screenA" class="computer-screen">Screen</div>
          <div id="msgA" class="msg-bubble d-none">{{ lesson.activity_json.message_a|default:"Hello ğŸ‘‹" }}</div>
        </div>

        <!-- INTERNET -->
        <div class="text-center my-3">
          <div id="internetRoad" class="internet-road">
            ğŸŒ Internet
            <div id="dataBubble" class="data-bubble d-none">ğŸ“¦</div>
          </div>
        </div>

        <!-- COMPUTER B -->
        <div class="computer-box mt-4">
          <div class="computer-title">ğŸ–¥ï¸ Computer B</div>
          <div id="screenB" class="computer-screen">Screen</div>
          <div id="msgB" class="msg-bubble d-none">{{ lesson.activity_json.message_b|default:"Hello ğŸ‘‹" }}</div>
        </div>

      </div>
    </div>

  </div>

  <!-- CONTROLS -->
  <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light rounded-4 shadow-sm">
    <div>
      <button id="runBtn" class="btn btn-primary me-2">â–¶ RUN</button>
      <button id="resetBtn" class="btn btn-outline-secondary">ğŸ”„ RESET</button>
    </div>

    <div class="fw-bold">â­ XP: {{ lesson.xp }}</div>
  </div>

  <!-- FEEDBACK -->
  <div id="resultBox" class="text-center mt-3 fw-bold fs-4"></div>

  <!-- NEXT BUTTON -->
  <div class="text-center mt-3">
    <a id="nextBtn" class="btn btn-success d-none" href="#">Next mission â†’</a>
  </div>

</div>

{# âœ… SOUND EFFECTS #}
<audio id="sfxPop" preload="auto">
  <source src="{% static 'sounds/pop.mp3' %}" type="audio/mpeg">
</audio>

<audio id="sfxWin" preload="auto">
  <source src="{% static 'sounds/success.mp3' %}" type="audio/mpeg">
</audio>

<style>
  .drop-zone{border:3px dashed #6c757d;border-radius:16px;padding:18px;background:#f8f9fa;min-height:160px;}
  .drop-zone.drag-over{border-color:#0d6efd;background:#e7f1ff;}
  .drop-hint{margin:0;color:#6c757d;font-weight:700;}
  .instruction-card{background:#fff3cd;border:2px solid #f7c948;padding:14px 16px;border-radius:14px;font-weight:800;cursor:grab;margin-bottom:12px;user-select:none;}
  .computer-box{border:1px solid #e9ecef;border-radius:16px;padding:14px 16px;background:#fff;}
  .computer-title{font-weight:800;margin-bottom:8px;}
  .computer-screen{margin-top:8px;padding:10px;border-radius:12px;background:#f1f3f5;border:2px solid transparent;display:inline-block;min-width:120px;text-align:center;font-weight:700;}
  .glow{background:#e7f1ff;border-radius:10px;padding:4px 8px;box-shadow:0 0 0 3px rgba(13,110,253,.15);transition:.2s;}
  .mouse-click{display:inline-block;animation:mouseClick .35s ease-in-out 2;}
  @keyframes mouseClick{0%{transform:scale(1)}50%{transform:scale(.88)}100%{transform:scale(1)}}
  .screen-on{background:#d1e7dd!important;border:2px solid #198754!important;box-shadow:0 0 18px rgba(25,135,84,.35);transition:.25s;}
  .internet-road{position:relative;display:inline-block;padding:10px 18px;border-radius:999px;border:2px dashed #0d6efd;background:#f8f9fa;font-weight:800;}
  .road-on{background:#e7f1ff;border-style:solid;box-shadow:0 0 18px rgba(13,110,253,.25);}
  .data-bubble{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:22px;}
  .bubble-move{display:block!important;animation:bubbleMove 1.2s ease-in-out forwards;}
  @keyframes bubbleMove{0%{left:8px;opacity:1}100%{left:calc(100% - 34px);opacity:1}}
  .msg-bubble{margin-top:10px;display:inline-block;background:#fff3cd;border:2px solid #f7c948;padding:8px 12px;border-radius:14px;font-weight:800;}
  .d-none{display:none!important;}
</style>

<script>
  // âœ… Read JSON config
  const activity = JSON.parse(document.getElementById("activity-data").textContent || "{}");

  const blocks = activity.blocks || [
    { id: "type", label: "ğŸŸ¨ Type message" },
    { id: "send", label: "ğŸŸ¨ Click send" },
    { id: "show", label: "ğŸŸ¨ Show on screen" }
  ];

  const correctOrder = activity.correct_order || ["type", "send", "show"];

  // âœ… Build the blocks dynamically
  const instructionsWrap = document.getElementById("instructions");
  instructionsWrap.innerHTML = "";

  blocks.forEach(b => {
    const div = document.createElement("div");
    div.className = "instruction-card";
    div.draggable = true;
    div.dataset.id = b.id;
    div.textContent = b.label;
    instructionsWrap.appendChild(div);
  });

  // Drag + Drop
  let draggedCard = null;

  function attachDragHandlers() {
    document.querySelectorAll(".instruction-card").forEach(card => {
      card.addEventListener("dragstart", (e) => {
        draggedCard = card;
        e.dataTransfer.setData("text/plain", card.dataset.id);
        setTimeout(() => card.classList.add("opacity-50"), 0);
        playSfx("sfxPop");
      });
      card.addEventListener("dragend", () => {
        draggedCard = null;
        card.classList.remove("opacity-50");
      });
    });
  }
  attachDragHandlers();

  const dropZone = document.getElementById("dropZone");

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("drag-over");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("drag-over");
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag-over");

    if (!draggedCard) return;

    const hint = dropZone.querySelector(".drop-hint");
    if (hint) hint.remove();

    dropZone.appendChild(draggedCard);
    playSfx("sfxPop");
  });

  function getCurrentOrder() {
    return Array.from(document.querySelectorAll("#dropZone .instruction-card"))
      .map(el => el.dataset.id);
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  function playSfx(id) {
    const audio = document.getElementById(id);
    if (!audio) return;
    try { audio.currentTime = 0; audio.play(); } catch(e){}
  }

  function resetAnimations() {
    document.getElementById("keyboardEl")?.classList.remove("glow");
    document.getElementById("mouseEl")?.classList.remove("mouse-click");
    document.getElementById("screenA")?.classList.remove("screen-on");
    document.getElementById("screenB")?.classList.remove("screen-on");
    document.getElementById("internetRoad")?.classList.remove("road-on");

    const bubble = document.getElementById("dataBubble");
    if (bubble) {
      bubble.classList.add("d-none");
      bubble.classList.remove("bubble-move");
      bubble.style.left = "8px";
    }

    document.getElementById("msgA")?.classList.add("d-none");
    document.getElementById("msgB")?.classList.add("d-none");
  }

  async function playSuccessAnimation() {
    resetAnimations();

    document.getElementById("keyboardEl")?.classList.add("glow");
    document.getElementById("msgA")?.classList.remove("d-none");
    await sleep(650);

    document.getElementById("mouseEl")?.classList.add("mouse-click");
    document.getElementById("internetRoad")?.classList.add("road-on");
    await sleep(600);

    document.getElementById("screenA")?.classList.add("screen-on");
    await sleep(450);

    const bubble = document.getElementById("dataBubble");
    if (bubble) {
      bubble.classList.remove("d-none");
      bubble.classList.add("bubble-move");
    }
    await sleep(1250);

    document.getElementById("screenB")?.classList.add("screen-on");
    document.getElementById("msgB")?.classList.remove("d-none");

    playSfx("sfxWin");
  }

  document.getElementById("runBtn").addEventListener("click", async () => {
    const resultBox = document.getElementById("resultBox");
    const userOrder = getCurrentOrder();

    if (userOrder.length !== correctOrder.length) {
      resultBox.className = "text-center mt-3 fw-bold fs-4 text-warning";
      resultBox.innerHTML = "ğŸ‘€ Drag all the blocks first!";
      return;
    }

    const ok = JSON.stringify(userOrder) === JSON.stringify(correctOrder);

    if (ok) {
      resultBox.className = "text-center mt-3 fw-bold fs-4 text-success";
      resultBox.innerHTML = activity.success_text || "ğŸ‰ Great job!";

      await playSuccessAnimation();
      await markComplete();
    } else {
      resultBox.className = "text-center mt-3 fw-bold fs-4 text-danger";
      resultBox.innerHTML = activity.fail_text || "ğŸ¤” Almost there! Try changing the order.";
    }
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    window.location.reload();
  });

  async function markComplete() {
    const res = await fetch("/lessons/{{ child.id }}/{{ lesson.id }}/complete/", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
    });

    const data = await res.json();

    if (data.ok) {
      const nextBtn = document.getElementById("nextBtn");
      if (nextBtn && data.next_url) {
        nextBtn.href = data.next_url;
        nextBtn.classList.remove("d-none");
      }
    }
  }
</script>
